<div class="app-wrapper">
  <!-- Header -->
  <app-header-layout></app-header-layout>

  <!-- Main content -->
  <div class="container-fluid mt-3">
    <div class="row" style="height: calc(100vh - 70px);">
      
      <!-- Sidebar -->
      <div [ngClass]="{'col-2': !isCollapsed, 'col-1': isCollapsed}">
        <app-sidebar
          [sidebarGroups]="sidebarGroups"
          [sidebarConnectedTo]="sidebarConnectedTo"
          (componentAdded)="onComponentAdded($event)">
        </app-sidebar>
      </div>

      <!-- Center Canvas Area -->
      <div [ngClass]="{'col-10': !isCollapsed, 'col-11': isCollapsed}" style="height: 100%; overflow-y: auto;">

        <app-page-manager></app-page-manager>

        <h5>Canvas</h5>
        <button class="btn btn-primary mb-3" (click)="addNewContainer()">Add New Container</button>

        <!-- Main Canvas with Default Container -->
        <div cdkDropList
             id="canvasList"
             [cdkDropListData]="canvasComponents"
             [cdkDropListConnectedTo]="canvasConnectedTo"
             (cdkDropListDropped)="drop($event)"
             class="p-1 bg-white border rounded"
             [ngStyle]="{
               'display': 'flex',
               'flex-direction': canvasConfig.flexDirection,
               'justify-content': canvasConfig.justifyContent,
               'flex-wrap': 'wrap',
               'gap': '12px',
               'min-height': 'calc(100vh - 200px)',
               'width': '100%'
             }">
          <!-- Empty state -->
          <div *ngIf="!canvasComponents.length" class="text-muted text-center w-100 p-5" (click)="$event.stopPropagation()">
            Drop components here
          </div>

          <!-- Recursive ng-template for rendering any component at any depth -->
          <ng-template #renderComponent let-comp let-parent="parent">
            <ng-container [ngSwitch]="comp.type">
              <!-- Container -->
              <ng-container *ngSwitchCase="'container'">
                <div cdkDropList
                     [id]="comp.id"
                     [cdkDropListData]="comp.children || []"

                     [cdkDropListConnectedTo]="getConnectedLists(comp)"
                     (cdkDropListDropped)="drop($event, comp)"
                     (click)="selectComponent(comp); $event.stopPropagation()"
                     class="p-2 border rounded position-relative"
                     [ngStyle]="getComponentStyle(comp)">
                  <!-- Empty placeholder -->
                  <div *ngIf="!comp.children?.length" class="text-muted text-center w-100" style="pointer-events: none;" (click)="$event.stopPropagation()">
                    Drop components here
                  </div>
                  <!-- Children -->
                  <ng-container *ngFor="let child of comp.children; trackBy: trackById">
                    <div cdkDrag
                         [cdkDragData]="child"
                         (click)="selectComponent(child); $event.stopPropagation()"
                         [ngStyle]="getChildStyle(child, comp)"
                         [ngClass]="{
                           'border': selectedComponent?.id === child.id,
                           'border-primary': selectedComponent?.id === child.id,
                           'position-relative': true,
                           'canvas-child': true
                         }">
                      <button *ngIf="selectedComponent?.id === child.id"
                              class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                              (click)="deleteSelected(); $event.stopPropagation()">✕</button>
                      <ng-template [ngTemplateOutlet]="renderComponent"
                                   [ngTemplateOutletContext]="{ $implicit: child, parent: comp }"></ng-template>
                    </div>
                  </ng-container>
                </div>
              </ng-container>

              <!-- Nav -->
              <ng-container *ngSwitchCase="'nav'">
                <div cdkDropList
                     [id]="comp.id"
                     [cdkDropListData]="comp.children || []"

                     [cdkDropListConnectedTo]="getConnectedLists(comp)"


                     (cdkDropListDropped)="drop($event, comp)"
                     (click)="selectComponent(comp); $event.stopPropagation()"
                     class="p-2 border rounded position-relative"
                     [ngStyle]="getComponentStyle(comp)">
                  <!-- Empty placeholder -->
                  <div *ngIf="!comp.children?.length" class="text-muted text-center w-100" style="pointer-events: none;" (click)="$event.stopPropagation()">
                    Drop components here
                  </div>
                  <!-- Children -->
                  <ng-container *ngFor="let child of comp.children; trackBy: trackById">
                    <div cdkDrag
                         [cdkDragData]="child"
                         (click)="selectComponent(child); $event.stopPropagation()"
                         [ngStyle]="getChildStyle(child, comp)"
                         [ngClass]="{
                           'border': selectedComponent?.id === child.id,
                           'border-primary': selectedComponent?.id === child.id,
                           'position-relative': true,
                           'canvas-child': true
                         }">
                      <button *ngIf="selectedComponent?.id === child.id"
                              class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                              (click)="deleteSelected(); $event.stopPropagation()">✕</button>
                      <ng-template [ngTemplateOutlet]="renderComponent"
                                   [ngTemplateOutletContext]="{ $implicit: child, parent: comp }"></ng-template>
                    </div>
                  </ng-container>
                </div>
              </ng-container>

              <!-- Text -->
              <ng-container *ngSwitchCase="'text'">
                <ng-container [ngSwitch]="comp.textStyle || 'p'">
                  <h1 *ngSwitchCase="'h1'" [ngStyle]="getChildStyle(comp, parent)" [innerHTML]="comp.text | safeHtml"></h1>
                  <h2 *ngSwitchCase="'h2'" [ngStyle]="getChildStyle(comp, parent)" [innerHTML]="comp.text | safeHtml"></h2>
                  <h3 *ngSwitchCase="'h3'" [ngStyle]="getChildStyle(comp, parent)" [innerHTML]="comp.text | safeHtml"></h3>
                  <h4 *ngSwitchCase="'h4'" [ngStyle]="getChildStyle(comp, parent)" [innerHTML]="comp.text | safeHtml"></h4>
                  <h5 *ngSwitchCase="'h5'" [ngStyle]="getChildStyle(comp, parent)" [innerHTML]="comp.text | safeHtml"></h5>
                  <h6 *ngSwitchCase="'h6'" [ngStyle]="getChildStyle(comp, parent)" [innerHTML]="comp.text | safeHtml"></h6>
                  <p *ngSwitchDefault [ngStyle]="getChildStyle(comp, parent)" [innerHTML]="comp.text | safeHtml"></p>
                </ng-container>
              </ng-container>

              <!-- List -->
              <ng-container *ngSwitchCase="'list'">
                <ng-container [ngSwitch]="comp.listType || 'unordered'">
                  <ul *ngSwitchCase="'unordered'" [ngStyle]="getChildStyle(comp, parent)" [ngClass]="comp.class || 'list-group'">
                    <li *ngFor="let item of comp.items; let i = index" class="list-group-item" [innerHTML]="item | safeHtml"></li>
                  </ul>
                  <ol *ngSwitchCase="'ordered'" [ngStyle]="getChildStyle(comp, parent)" [ngClass]="comp.class || 'list-group'">
                    <li *ngFor="let item of comp.items; let i = index" class="list-group-item" [innerHTML]="item | safeHtml"></li>
                  </ol>
                </ng-container>
              </ng-container>

              <!-- Input Components -->
              <input *ngSwitchCase="'input'" class="form-control" [(ngModel)]="comp.text"
                     [attr.placeholder]="comp.placeholder || 'Enter input here'" [ngClass]="comp.class"
                     [ngStyle]="getChildStyle(comp, parent)" (ngModelChange)="onTextChange(comp, $event); $event.stopPropagation()" />
              <input *ngSwitchCase="'email'" type="email" class="form-control" [(ngModel)]="comp.text"
                     [attr.placeholder]="comp.placeholder || 'Enter email'" [ngClass]="comp.class"
                     [ngStyle]="getChildStyle(comp, parent)" (ngModelChange)="onTextChange(comp, $event); $event.stopPropagation()" />
              <textarea *ngSwitchCase="'textarea'" class="form-control" [(ngModel)]="comp.text"
                        [attr.placeholder]="comp.placeholder || 'Enter details here'" [ngClass]="comp.class"
                        [ngStyle]="getChildStyle(comp, parent)" (ngModelChange)="onTextChange(comp, $event); $event.stopPropagation()"></textarea>
              <input *ngSwitchCase="'password'" type="password" class="form-control" [(ngModel)]="comp.text"
                     [placeholder]="comp.placeholder" [ngClass]="comp.class"
                     [ngStyle]="getChildStyle(comp, parent)" (ngModelChange)="onTextChange(comp, $event); $event.stopPropagation()" />
              <input *ngSwitchCase="'number'" type="number" class="form-control" [(ngModel)]="comp.text"
                     [placeholder]="comp.placeholder" [ngClass]="comp.class"
                     [ngStyle]="getChildStyle(comp, parent)" (ngModelChange)="onTextChange(comp, $event); $event.stopPropagation()" />
              <input *ngSwitchCase="'date'" type="date" class="form-control" [(ngModel)]="comp.text"
                     [placeholder]="comp.placeholder" [ngClass]="comp.class"
                     [ngStyle]="getChildStyle(comp, parent)" (ngModelChange)="onTextChange(comp, $event); $event.stopPropagation()" />
              <select *ngSwitchCase="'select'" class="form-select" [(ngModel)]="comp.value" [ngClass]="comp.class"
                      [ngStyle]="getChildStyle(comp, parent)" (ngModelChange)="onComponentUpdated(comp); $event.stopPropagation()">
                <option *ngFor="let opt of comp.options" [value]="opt">{{ opt }}</option>
              </select>
              <div *ngSwitchCase="'checkbox'" class="form-group" [ngClass]="comp.class"
                   [ngStyle]="getChildStyle(comp, parent)">
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" [(ngModel)]="comp.checked"
                         [ngStyle]="getChildStyle(comp, parent)" (ngModelChange)="onComponentUpdated(comp); $event.stopPropagation()" />
                  <span class="form-check-label">{{ comp.text || 'Checkbox' }}</span>
                </label>
              </div>
              <div *ngSwitchCase="'radio-group'" class="form-group" [ngClass]="comp.class"
                   [ngStyle]="getChildStyle(comp, parent)">
                <label *ngFor="let opt of comp.options; let i = index" class="form-check">
                  <input type="radio" class="form-check-input" [name]="comp.id" [value]="opt" [(ngModel)]="comp.value"
                         [ngClass]="comp.radioStyle" [ngStyle]="getChildStyle(comp, parent)"
                         (ngModelChange)="onComponentUpdated(comp); $event.stopPropagation()" />
                  <span class="form-check-label">{{ opt }}</span>
                </label>
              </div>

              <!-- Button -->
              <button *ngSwitchCase="'button'" type="button" class="btn" [ngClass]="comp.btnStyle || 'btn-primary'"
                      [ngStyle]="getChildStyle(comp, parent)" (click)="selectComponent(comp); $event.stopPropagation()">
                {{ comp.text || 'Button' }}
              </button>

              <!-- Image -->
              <img *ngSwitchCase="'image'" class="img-fluid" [src]="comp.src || 'https://via.placeholder.com/150'"
                   [alt]="comp.alt" [ngClass]="comp.class" [ngStyle]="getChildStyle(comp, parent)"
                   (click)="selectComponent(comp); $event.stopPropagation()" />

              <!-- Icon -->
              <i *ngSwitchCase="'icon'" [class]="comp.iconClass || 'ti ti-box'" [ngClass]="comp.class"
                 [ngStyle]="getChildStyle(comp, parent)" (click)="selectComponent(comp); $event.stopPropagation()"></i>

              <!-- Link -->
              <a *ngSwitchCase="'link'" [href]="comp.href || '#'" [ngClass]="comp.class"
                 [ngStyle]="getChildStyle(comp, parent)" (click)="selectComponent(comp); $event.stopPropagation()">
                {{ comp.text || 'Link' }}
              </a>

              <!-- Divider -->
              <hr *ngSwitchCase="'divider'" [ngClass]="comp.class" [ngStyle]="getChildStyle(comp, parent)"
                  (click)="selectComponent(comp); $event.stopPropagation()" />

              <!-- Progress -->
              <div *ngSwitchCase="'progress'" class="progress" style="height: 20px;" [ngClass]="comp.class"
                   [ngStyle]="getChildStyle(comp, parent)" (click)="selectComponent(comp); $event.stopPropagation()">
                <div class="progress-bar" [style.width.%]="comp.progress || 0" [style.background-color]="comp.barColor">
                  {{ (comp.progress || 0) + '%' }}
                </div>
              </div>

              <!-- Video -->
              <video *ngSwitchCase="'video'" class="w-100" [src]="comp.src" [controls]="comp.controls"
                     [autoplay]="comp.autoplay" [ngClass]="comp.class" [ngStyle]="getChildStyle(comp, parent)"
                     (click)="selectComponent(comp); $event.stopPropagation()"></video>

              <!-- Iframe -->
              <iframe *ngSwitchCase="'iframe'" class="w-100" [src]="comp.src" [title]="comp.title"
                      [ngClass]="comp.class" [ngStyle]="getChildStyle(comp, parent)"
                      (click)="selectComponent(comp); $event.stopPropagation()"></iframe>

              <!-- Table -->
              <table *ngSwitchCase="'table'" [ngClass]="comp.class" [ngStyle]="getChildStyle(comp, parent)"
                     (click)="selectComponent(comp); $event.stopPropagation()">
                <thead>
                  <tr>
                    <th *ngFor="let header of comp.headers; let ci = index"
                        [style.background-color]="getHeaderCellColor(ci, comp)"
                        [style.color]="getTextColor(getHeaderCellColor(ci, comp))">
                      {{ header }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of comp.rows; let ri = index">
                    <td *ngFor="let cell of row; let ci = index"
                        [style.background-color]="getCellBackgroundColor(ri, ci, comp)"
                        [style.color]="getTextColor(getCellBackgroundColor(ri, ci, comp))">
                      <input *ngIf="selectedComponent?.id === comp.id" [formControl]="cellControls[ri][ci]" class="form-control"
                             (click)="$event.stopPropagation()">
                      <span *ngIf="selectedComponent?.id !== comp.id">{{ cell }}</span>
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- Default case -->
              <ng-container *ngSwitchDefault>
                <div [ngStyle]="getChildStyle(comp, parent)" (click)="selectComponent(comp); $event.stopPropagation()">
                  {{ comp.displayName || comp.type }}
                </div>
              </ng-container>
            </ng-container>
          </ng-template>

          <!-- Top-level components -->
          <ng-container *ngFor="let comp of canvasComponents; trackBy: trackById">
            <div cdkDrag
                 [cdkDragData]="comp"
                 (click)="selectComponent(comp); $event.stopPropagation()"
                 [ngStyle]="getComponentStyle(comp)"
                 [ngClass]="{
                   'border': selectedComponent?.id === comp.id,
                   'border-primary': selectedComponent?.id === comp.id,
                   'position-relative': true,
                   'canvas-item': true
                 }">
              <button *ngIf="selectedComponent?.id === comp.id"
                      class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                      (click)="deleteSelected(); $event.stopPropagation()">✕</button>
              <ng-template [ngTemplateOutlet]="renderComponent"
                           [ngTemplateOutletContext]="{ $implicit: comp, parent: null }"></ng-template>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Save -->
      <div class="text-end mt-3">
        <button class="btn btn-primary" (click)="onSave()">Save</button>
      </div>
    </div>

    <!-- Properties Panel -->
    <div *ngIf="selectedComponent" class="properties-panel">
      <app-properties-panel
        [selectedComponent]="selectedComponent"
        (componentUpdated)="onComponentUpdated($event)"
        (save)="onSave()"
        (cancel)="deselectComponent()"></app-properties-panel>
    </div>
  </div>

</div>

